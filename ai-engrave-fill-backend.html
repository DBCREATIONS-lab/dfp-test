<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Laser Engraving Fill Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 0;
            min-height: 600px;
        }

        .controls {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
            max-height: 80vh;
        }

        .preview-area {
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #ffffff;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.95em;
        }

        .control-group input[type="text"],
        .control-group textarea,
        .control-group select,
        .control-group input[type="number"],
        .control-group input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .control-group input:focus,
        .control-group textarea:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .control-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .range-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-group input[type="range"] {
            flex: 1;
        }

        .range-group .range-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .status-indicator {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-indicator.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-indicator.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-indicator.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(0,0,0,0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .preview-container {
            width: 100%;
            max-width: 800px;
            min-height: 400px;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
            padding: 20px;
        }

        .preview-container img {
            max-width: 100%;
            max-height: 600px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: block;
        }

        .preview-placeholder {
            text-align: center;
            color: #6c757d;
            padding: 40px;
        }

        .preview-placeholder svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .style-presets {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .style-preset {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
            background: white;
        }

        .style-preset:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .style-preset.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .cost-estimate {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .download-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .download-actions .btn {
            flex: 1;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .controls {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• AI Laser Engraving Fill Generator</h1>
            <p>Generate intricate scrollwork and filigree designs for laser engraving</p>
        </div>

        <div class="main-content">
            <div class="controls">
                <div id="statusMessage"></div>

                <div class="info-box">
                    <strong>üéØ How it works:</strong><br>
                    1. Upload your boundary outline (knife blade, panel, etc.)<br>
                    2. Choose a style preset or write custom prompt<br>
                    3. Adjust generation settings<br>
                    4. Click "Generate Design"<br>
                    5. Download result for laser engraving
                </div>

                <div class="cost-estimate">
                    <strong>üí∞ Cost:</strong> ~$0.10-0.50 per generation<br>
                    <small>Charged to your Replicate account</small>
                </div>

                <div class="control-group">
                    <label>üìÇ Upload Boundary Outline</label>
                    <input type="file" id="boundaryUpload" accept="image/png,image/jpeg" style="display: none;">
                    <button class="btn btn-secondary" id="uploadBoundaryBtn" style="margin-bottom: 0;">
                        üì§ Choose File
                    </button>
                    <div id="fileInfo" style="margin-top: 10px; font-size: 0.9em; color: #495057;"></div>
                    <small style="color: #6c757d; display: block; margin-top: 5px;">
                        Upload PNG or JPG of your shape outline (SVG not supported for AI generation)
                    </small>
                </div>

                <div class="control-group">
                    <label>Style Preset</label>
                    <div class="style-presets" id="stylePresets">
                        <div class="style-preset active" data-style="western">Western</div>
                        <div class="style-preset" data-style="baroque">Baroque</div>
                        <div class="style-preset" data-style="victorian">Victorian</div>
                        <div class="style-preset" data-style="oriental">Oriental</div>
                        <div class="style-preset" data-style="tribal">Tribal</div>
                        <div class="style-preset" data-style="custom">Custom</div>
                    </div>
                </div>

                <div class="control-group">
                    <label>Custom Prompt</label>
                    <textarea id="promptInput" placeholder="Describe the scrollwork design you want...">intricate western scrollwork engraving pattern, flowing acanthus leaves and baroque flourishes, ornate decorative fill, black and white line art, laser engraving ready, detailed filigree design</textarea>
                </div>

                <div class="control-group">
                    <label>Negative Prompt (what to avoid)</label>
                    <textarea id="negativePromptInput" placeholder="Things to avoid in the design...">blurry, low quality, pixelated, color, photographic, 3d render, text, watermark</textarea>
                </div>

                <div class="control-group">
                    <label>Guidance Scale</label>
                    <div class="range-group">
                        <input type="range" id="guidanceScale" min="5" max="20" value="12" step="0.5">
                        <span class="range-value" id="guidanceScaleValue">12</span>
                    </div>
                    <small style="color: #6c757d;">Higher = follows prompt more closely</small>
                </div>

                <div class="control-group">
                    <label>Steps</label>
                    <div class="range-group">
                        <input type="range" id="steps" min="20" max="100" value="50" step="5">
                        <span class="range-value" id="stepsValue">50</span>
                    </div>
                    <small style="color: #6c757d;">More steps = higher quality (slower)</small>
                </div>

                <div class="control-group">
                    <label>ControlNet Strength</label>
                    <div class="range-group">
                        <input type="range" id="controlnetStrength" min="0.5" max="2.0" value="1.5" step="0.1">
                        <span class="range-value" id="controlnetStrengthValue">1.5</span>
                    </div>
                    <small style="color: #6c757d;">Higher = follows boundary more strictly</small>
                </div>

                <button class="btn btn-primary" id="generateBtn">
                    üé® Generate Design
                </button>

                <button class="btn btn-secondary" id="testConnectionBtn">
                    üîå Test Server Connection
                </button>
            </div>

            <div class="preview-area">
                <div class="preview-container" id="previewContainer">
                    <div class="preview-placeholder">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                        <h3>No design generated yet</h3>
                        <p>Configure your settings and click "Generate Design"</p>
                    </div>
                </div>

                <div class="download-actions" id="downloadActions" style="display: none;">
                    <button class="btn btn-primary" id="downloadBtn">
                        üíæ Download PNG
                    </button>
                    <button class="btn btn-secondary" id="regenerateBtn">
                        üîÑ Generate New
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000';
        let currentImageUrl = null;
        let selectedStyle = 'western';
        let boundaryFile = null;

        const stylePrompts = {
            western: "intricate western scrollwork engraving pattern, flowing acanthus leaves and baroque flourishes, ornate decorative fill, black and white line art, laser engraving ready, detailed filigree design",
            baroque: "ornate baroque scrollwork engraving, elaborate rococo flourishes, symmetrical decorative patterns, classical European filigree, black and white line art, laser engraving ready",
            victorian: "Victorian era scrollwork design, delicate floral flourishes, elegant vintage filigree patterns, ornamental line art, black and white laser engraving ready",
            oriental: "oriental scrollwork pattern, flowing asian cloud motifs, decorative eastern flourishes, intricate traditional linework, black and white laser engraving ready",
            tribal: "tribal scrollwork pattern, bold geometric flourishes, ethnic decorative linework, stylized ornamental design, black and white laser engraving ready",
            custom: ""
        };

        // Elements
        const generateBtn = document.getElementById('generateBtn');
        const testConnectionBtn = document.getElementById('testConnectionBtn');
        const uploadBoundaryBtn = document.getElementById('uploadBoundaryBtn');
        const boundaryUpload = document.getElementById('boundaryUpload');
        const fileInfo = document.getElementById('fileInfo');
        const promptInput = document.getElementById('promptInput');
        const negativePromptInput = document.getElementById('negativePromptInput');
        const guidanceScale = document.getElementById('guidanceScale');
        const guidanceScaleValue = document.getElementById('guidanceScaleValue');
        const steps = document.getElementById('steps');
        const stepsValue = document.getElementById('stepsValue');
        const controlnetStrength = document.getElementById('controlnetStrength');
        const controlnetStrengthValue = document.getElementById('controlnetStrengthValue');
        const previewContainer = document.getElementById('previewContainer');
        const downloadActions = document.getElementById('downloadActions');
        const downloadBtn = document.getElementById('downloadBtn');
        const regenerateBtn = document.getElementById('regenerateBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Style preset selection
        document.getElementById('stylePresets').addEventListener('click', (e) => {
            if (e.target.classList.contains('style-preset')) {
                document.querySelectorAll('.style-preset').forEach(p => p.classList.remove('active'));
                e.target.classList.add('active');
                selectedStyle = e.target.dataset.style;
                
                if (selectedStyle !== 'custom') {
                    promptInput.value = stylePrompts[selectedStyle];
                }
            }
        });

        // Range slider updates
        guidanceScale.addEventListener('input', () => {
            guidanceScaleValue.textContent = guidanceScale.value;
        });

        steps.addEventListener('input', () => {
            stepsValue.textContent = steps.value;
        });

        controlnetStrength.addEventListener('input', () => {
            controlnetStrengthValue.textContent = controlnetStrength.value;
        });

        // File upload handling
        uploadBoundaryBtn.addEventListener('click', () => {
            boundaryUpload.click();
        });

        boundaryUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            console.log('üìÇ File selected:', file);
            
            if (file) {
                console.log('üìä File details:', {
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
                
                boundaryFile = file;
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                fileInfo.innerHTML = `‚úÖ <strong>${file.name}</strong> (${sizeMB} MB)`;
                fileInfo.style.color = '#28a745';
                
                console.log('üñºÔ∏è Creating preview...');
                
                // Show preview of boundary
                const reader = new FileReader();
                reader.onload = (event) => {
                    console.log('‚úÖ File read successfully');
                    previewContainer.innerHTML = `
                        <div style="text-align: center;">
                            <img src="${event.target.result}" alt="Boundary preview" style="max-width: 100%; max-height: 400px; border: 2px solid #667eea; border-radius: 8px;">
                            <p style="margin-top: 15px; color: #6c757d;">Boundary outline ready - click "Generate Design" to fill it</p>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                console.log('‚ùå No file selected');
            }
        });

        // Status message helper
        function showStatus(message, type = 'info') {
            statusMessage.innerHTML = `<div class="status-indicator ${type}">
                ${type === 'info' ? '<span class="loading"></span>' : ''}
                ${message}
            </div>`;
        }

        function hideStatus() {
            statusMessage.innerHTML = '';
        }

        // Test connection
        testConnectionBtn.addEventListener('click', async () => {
            try {
                showStatus('Testing server connection...', 'info');
                const response = await fetch(`${API_BASE_URL}/api/test`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    if (data.hasToken) {
                        showStatus('‚úÖ Server connected and API token configured!', 'success');
                    } else {
                        showStatus('‚ö†Ô∏è Server connected but no API token found. Check .env file.', 'warning');
                    }
                } else {
                    showStatus('‚ùå Server test failed', 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Cannot connect to server. Make sure it's running: ${error.message}`, 'error');
            }
        });

        // Generate design
        generateBtn.addEventListener('click', async () => {
            console.log('üéØ Generate button clicked!');
            const prompt = promptInput.value.trim();
            console.log('üìù Prompt:', prompt);
            console.log('üìÅ Boundary file:', boundaryFile);
            
            if (!prompt) {
                console.log('‚ùå No prompt provided');
                showStatus('‚ö†Ô∏è Please enter a prompt', 'warning');
                return;
            }

            if (!boundaryFile) {
                console.log('‚ùå No boundary file provided');
                showStatus('‚ö†Ô∏è Please upload a boundary outline first', 'warning');
                return;
            }

            console.log('‚úÖ All checks passed, starting generation...');

            try {
                generateBtn.disabled = true;
                generateBtn.textContent = 'üé® Generating...';
                console.log('‚úÖ All checks passed, starting generation...');

                // Create FormData for file upload
                console.log('üì¶ Creating FormData...');
                const formData = new FormData();
                formData.append('boundaryImage', boundaryFile);
                formData.append('prompt', prompt);
                formData.append('negativePrompt', negativePromptInput.value);
                formData.append('guidanceScale', guidanceScale.value);
                formData.append('steps', steps.value);
                formData.append('controlnetStrength', controlnetStrength.value);

                console.log('üöÄ Making API call to:', `${API_BASE_URL}/api/generate`);
                console.log('üìã Request data:', {
                    prompt: prompt,
                    negativePrompt: negativePromptInput.value,
                    guidanceScale: guidanceScale.value,
                    steps: steps.value,
                    controlnetStrength: controlnetStrength.value,
                    fileSize: boundaryFile.size,
                    fileName: boundaryFile.name
                });

                const response = await fetch(`${API_BASE_URL}/api/generate`, {
                    method: 'POST',
                    body: formData
                });

                console.log('üì° Response received:', response);
                console.log('üìä Response status:', response.status, response.statusText);

                const data = await response.json();
                console.log('üìÑ Response data:', data);

                console.log('üìÑ Response data:', data);

                if (data.success && data.imageUrl) {
                    console.log('üéâ Generation successful! Image URL:', data.imageUrl);
                    currentImageUrl = data.imageUrl;
                    
                    // Show loading state first
                    previewContainer.innerHTML = `
                        <div style="text-align: center; width: 100%;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">üé® Loading Generated Design...</h3>
                            <div class="loading" style="margin: 20px auto;"></div>
                            <p style="color: #6c757d;">Your AI-generated design is loading...</p>
                        </div>
                    `;
                    
                    // Load the image with forced display
                    const img = new Image();
                    img.onload = function() {
                        console.log('üñºÔ∏è Image loaded successfully');
                        console.log('üìê Image dimensions:', img.naturalWidth, 'x', img.naturalHeight);
                        
                        // Force clear everything and display image
                        previewContainer.style.background = 'white';
                        previewContainer.style.border = '3px solid #667eea';
                        previewContainer.style.padding = '20px';
                        previewContainer.style.minHeight = 'auto';
                        
                        // Create simple image element directly
                        const imgElement = document.createElement('img');
                        imgElement.src = data.imageUrl;
                        imgElement.style.width = '100%';
                        imgElement.style.height = 'auto';
                        imgElement.style.maxWidth = '800px';
                        imgElement.style.display = 'block';
                        imgElement.style.margin = '0 auto';
                        imgElement.style.border = '2px solid #333';
                        imgElement.alt = 'Generated AI Design';
                        
                        // Clear and add elements
                        previewContainer.innerHTML = '';
                        
                        const title = document.createElement('h2');
                        title.textContent = 'üé® AI Generated Scrollwork Design';
                        title.style.color = '#667eea';
                        title.style.textAlign = 'center';
                        title.style.marginBottom = '20px';
                        
                        const subtitle = document.createElement('p');
                        subtitle.textContent = `Ready for laser engraving ‚Ä¢ ${img.naturalWidth} x ${img.naturalHeight} pixels`;
                        subtitle.style.color = '#666';
                        subtitle.style.textAlign = 'center';
                        subtitle.style.marginBottom = '15px';
                        
                        const linkP = document.createElement('p');
                        linkP.style.textAlign = 'center';
                        linkP.style.marginTop = '15px';
                        const directLink = document.createElement('a');
                        directLink.href = data.imageUrl;
                        directLink.target = '_blank';
                        directLink.textContent = 'üîó Open in New Tab';
                        directLink.style.color = '#667eea';
                        directLink.style.textDecoration = 'underline';
                        linkP.appendChild(directLink);
                        
                        // Add all elements
                        previewContainer.appendChild(title);
                        previewContainer.appendChild(subtitle);
                        previewContainer.appendChild(imgElement);
                        previewContainer.appendChild(linkP);
                        
                        console.log('‚úÖ Image display forced into DOM');
                    };
                    img.onerror = function() {
                        console.error('‚ùå Image failed to load');
                        previewContainer.innerHTML = `
                            <div style="text-align: center; width: 100%; padding: 20px;">
                                <h3 style="color: #dc3545; margin-bottom: 15px;">‚ùå Image Load Failed</h3>
                                <p style="color: #6c757d; margin-bottom: 15px;">
                                    The image was generated but failed to display here.
                                </p>
                                <div style="background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; padding: 20px; margin: 10px 0;">
                                    <p style="margin-bottom: 10px;"><strong>Generated Image URL:</strong></p>
                                    <p style="word-break: break-all; font-family: monospace; background: white; padding: 8px; border-radius: 4px; font-size: 0.8em;">
                                        ${data.imageUrl}
                                    </p>
                                </div>
                                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                    <a href="${data.imageUrl}" target="_blank" 
                                       style="background: #667eea; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 600;">
                                        üåê View in New Tab
                                    </a>
                                    <button onclick="window.open('${data.imageUrl}', '_blank')" 
                                            style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                        üñºÔ∏è Open Image
                                    </button>
                                </div>
                            </div>
                        `;
                    };
                    img.src = data.imageUrl;
                    
                    downloadActions.style.display = 'flex';
                    showStatus('‚úÖ Design generated successfully!', 'success');
                    
                    setTimeout(hideStatus, 5000);
                } else {
                    console.log('‚ùå Generation failed:', data.error || 'Unknown error');
                    throw new Error(data.error || 'Generation failed');
                }

            } catch (error) {
                console.error('üí• Error during generation:', error);
                console.error('üîç Error details:', error.message);
                showStatus(`‚ùå Generation failed: ${error.message}`, 'error');
                console.error('Generation error:', error);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'üé® Generate Design';
            }
        });

        // Download button
        downloadBtn.addEventListener('click', async () => {
            if (!currentImageUrl) return;

            try {
                const response = await fetch(currentImageUrl);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `laser-engrave-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showStatus('‚úÖ Downloaded successfully!', 'success');
                setTimeout(hideStatus, 3000);
            } catch (error) {
                showStatus('‚ùå Download failed: ' + error.message, 'error');
            }
        });

        // Regenerate button
        regenerateBtn.addEventListener('click', () => {
            generateBtn.click();
        });

        // Test connection on load
        setTimeout(() => {
            testConnectionBtn.click();
        }, 500);
    </script>
</body>
</html>
